import{S as h,i as g,s as k,B as S,a as w,k as v,c as I,l as T,m as $,h as i,n as b,b as c,C,D as F,E as O,f as P,t as j,o as A}from"../../chunks/index-f7b1ee1a.js";import{l as J,d}from"../../chunks/database-4df4be65.js";import{g as p,U as m}from"../../chunks/tokens-27e6d90b.js";async function _(n,r,l){let a=n.concat(r);for(const s of a)s.synced=!0,await d.tasks.put(s);for(const s of l){let e=JSON.parse(localStorage.getItem("deletedTaskIds")||"[]");await d.tasks.delete(s),e=e.filter(t=>t!==s),localStorage.setItem("deletedTaskIds",JSON.stringify(e))}}async function u(){let n=parseFloat(localStorage.getItem("lastPulled")||"0"),r=m.tasks_sync+"?last_pulled="+n,l=await fetch(r,{headers:await p()});if(l.ok){let a=await l.json(),s=a.created,e=a.updated,t=a.deleted,o=parseFloat(a.timestamp);(s.length>0||e.length>0||t.length>0)&&(await _(s,e,t),localStorage.setItem("lastPulled",o.toString()))}}async function f(){let n=await d.tasks.filter(a=>{let s=a.synced,e=a.created_at===void 0;return!s&&e}).toArray(),r=await d.tasks.filter(a=>{let s=a.synced,e=a.created_at===void 0;return!s&&!e}).toArray(),l=JSON.parse(localStorage.getItem("deletedTaskIds")||"[]");if(n.length>0||r.length>0||l.length>0){let a={created:n,updated:r,deleted:l},s=await fetch(m.tasks_sync,{method:"POST",headers:await p(),body:JSON.stringify(a)});if(s.ok){let e=await s.json(),t=e.created,o=e.updated,y=e.deleted;await _(t,o,y)}}}async function N(){await u(),J(()=>d.tasks.toArray()).subscribe(async r=>{await f()}),setInterval(async()=>{await u(),await f()},1e4)}function D(n){let r,l,a;const s=n[1].default,e=S(s,n,n[0],null);return{c(){r=w(),l=v("div"),e&&e.c(),this.h()},l(t){r=I(t),l=T(t,"DIV",{class:!0});var o=$(l);e&&e.l(o),o.forEach(i),this.h()},h(){b(l,"class","container")},m(t,o){c(t,r,o),c(t,l,o),e&&e.m(l,null),a=!0},p(t,[o]){e&&e.p&&(!a||o&1)&&C(e,s,t,t[0],a?O(s,t[0],o,null):F(t[0]),null)},i(t){a||(P(e,t),a=!0)},o(t){j(e,t),a=!1},d(t){t&&i(r),t&&i(l),e&&e.d(t)}}}function L(n,r,l){let{$$slots:a={},$$scope:s}=r;return A(()=>{N()}),n.$$set=e=>{"$$scope"in e&&l(0,s=e.$$scope)},[s,a]}class q extends h{constructor(r){super(),g(this,r,L,D,k,{})}}export{q as default};
